name: work-flow
on:
  push: 

jobs:
    semgrep_scan: # SAST (static application security testing)
      name: testing semgrep
      runs-on: ubuntu-latest
      container:
        image: semgrep/semgrep
      steps:
        - name: Checkout
          uses: actions/checkout@v6.0.2

        - name: Run semgrep scans
          run: semgrep scan --config auto --sarif-output=semgrep-reports.sarif  --json-output=semgrep-results.json --severity ERROR --severity WARNING

        - name: Upload SARIF to GitHub
          if: always()
          uses: github/codeql-action/upload-sarif@v3
          with:
            sarif_file: semgrep-reports.sarif


        - name: Upload a sarif Artifact
          if: always()
          uses: actions/upload-artifact@v6.0.0
          with:
            name: semgrep-sarif
            path: semgrep-reports.sarif 
                        

        - name: Upload a json Artifact
          if: always()
          uses: actions/upload-artifact@v6.0.0
          with:
            name: semgrep-json
            path: semgrep-results.json

    gitleaks_scan: # secret testing
      name: testing gitleaks
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v6.0.2

        - name: Gitleaks
          uses: gitleaks/gitleaks-action@v2.3.9
          # continue-on-error: true
          with:
            args: detect --report-format html --report-path gitleaks.html 

        - name: Upload a html Artifact
          if: always()
          uses: actions/upload-artifact@v6.0.0
          with:
            name: gitleaks
            path: gitleaks.html
    image_scan: #SCA (Software Composition Analysis) of both the OS and Application layers  + Container Security
        name: Image Scan
        runs-on: ubuntu-latest
        steps:
        - name: Checkout
          uses: actions/checkout@v6.0.2
        -
          name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ vars.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Docker Setup Buildx
          uses: docker/setup-buildx-action@v3.12.0

        - name: Build and push Docker images
          uses: docker/build-push-action@v6.18.0
          with:
            load: true
            cache-from: type=gha
            cache-to: type=gha,mode=max
            tags: image/test:v1

        - name: Docker Scout
          uses: docker/scout-action@v1.18.2
          with:
            command: quickview, cves 
            image: image/test:v1
            only-severities: critical,high
            sarif-file: docker-scout-reports.sarif
            
        - name: Upload a Build Artifact
          if: always()
          uses: actions/upload-artifact@v6.0.0
          with:
            name: docker-scout-reports
            path: docker-scout-reports.sarif

# ------------------------------------------------------------------
    # JOB 4: Centralized Reporting (DefectDojo)
    # Focus: Aggregates all previous findings into one dashboard
    # ------------------------------------------------------------------
    defectdojo_upload:
      name: Upload to DefectDojo
      runs-on: ubuntu-latest
      needs: [semgrep_scan, gitleaks_scan, image_scan] # Waits for all scans to finish
      if: always() # Run even if a scan failed (so we see the bugs)
      steps:
        - name: Download All Artifacts
          uses: actions/download-artifact@v4
          with:
            pattern: "*-reports" # Downloads artifacts from previous jobs
            path: ./reports

        - name: Upload Semgrep Results
          run: |
            curl -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
              -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
              -F "active=true" \
              -F "verified=true" \
              -F "scan_type=SARIF" \
              -F "minimum_severity=Low" \
              -F "engagement_name=CI/CD Pipeline (${{ github.run_number }})" \
              -F "product_name=My Robot Shop" \
              -F "file=@reports/semgrep-reports/semgrep-reports.sarif"

        - name: Upload Gitleaks Results
          run: |
            curl -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
              -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
              -F "active=true" \
              -F "verified=true" \
              -F "scan_type=Gitleaks Scan" \
              -F "engagement_name=CI/CD Pipeline (${{ github.run_number }})" \
              -F "product_name=My Robot Shop" \
              -F "file=@reports/gitleaks/gitleaks-results.sarif"

        - name: Upload Docker Scout Results
          run: |
            curl -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
              -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
              -F "active=true" \
              -F "verified=true" \
              -F "scan_type=SARIF" \
              -F "engagement_name=CI/CD Pipeline (${{ github.run_number }})" \
              -F "product_name=My Robot Shop" \
              -F "file=@reports/docker-scout-reports/docker-scout.sarif"